name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test-python:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Set up uv
      uses: astral-sh/setup-uv@v7
      with:
        python-version: ${{ matrix.python-version }}
        working-directory: bindings/python

    - name: Install Python dependencies
      working-directory: bindings/python
      run: |
        uv venv
        uv pip install maturin -e ".[dev]"

    - name: Generate Python stubs (pyo3-stub-gen)
      working-directory: bindings/python
      run: |
        cargo run --bin stub_gen
        git diff --exit-code -- formualizer/__init__.pyi

    - name: Build Python extension
      working-directory: bindings/python
      run: |
        source .venv/bin/activate
        maturin develop

    - name: Run Python linting
      working-directory: bindings/python
      run: |
        source .venv/bin/activate
        ruff check .
        ruff format --check .

    - name: Run Python type checking
      working-directory: bindings/python
      run: |
        source .venv/bin/activate
        mypy formualizer

    - name: Run Python tests with coverage
      working-directory: bindings/python
      run: |
        source .venv/bin/activate
        pytest

    - name: Upload coverage artifact
      if: ${{ !env.ACT && matrix.python-version == '3.12' }}
      uses: actions/upload-artifact@v4
      with:
        name: python-coverage
        path: bindings/python/coverage.xml
        if-no-files-found: error

  test-rust:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: 1.93.0
        components: rustfmt, clippy

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Check Rust formatting
      run: cargo fmt --all -- --check

    - name: Run Rust clippy
      run: cargo clippy --workspace --all-targets --all-features -- -D warnings

    - name: Run Rust tests
      run: cargo test --all-features

    - name: Run CFFI smoke test
      shell: bash
      run: |
        set -euo pipefail
        cargo run -p formualizer-cffi --bin cffi_smoke_setup
        cargo build -p formualizer-cffi
        cc crates/formualizer-cffi/tests/cffi_smoke.c \
          -I crates/formualizer-cffi/include \
          -L target/debug \
          -lformualizer_cffi \
          -Wl,-rpath,$PWD/target/debug \
          -o target/cffi_smoke
        target/cffi_smoke

  build-wheels:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Build wheels
      uses: PyO3/maturin-action@v1
      with:
        working-directory: bindings/python
        # Build a single abi3 wheel (not one per Python interpreter)
        # In `act` (local CI), avoid nested manylinux Docker to keep things working.
        args: --release --out dist --interpreter ${{ env.ACT && 'python3' || '/opt/python/cp310-cp310/bin/python' }}
        manylinux: ${{ env.ACT && 'off' || 'manylinux2014' }}
        sccache: 'true'

    - name: Upload wheels
      if: ${{ !env.ACT }}
      uses: actions/upload-artifact@v4
      with:
        name: wheels-${{ matrix.os }}
        path: bindings/python/dist

  coverage-badge:
    needs: [test-python, test-rust]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Download Python coverage artifact
      uses: actions/download-artifact@v4
      with:
        name: python-coverage
        path: coverage-artifacts

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Generate Python coverage badge
      shell: bash
      run: |
        set -euo pipefail

        python - <<'PY'
        import math
        import xml.etree.ElementTree as ET
        from pathlib import Path

        xml_path = Path('coverage-artifacts/coverage.xml')
        root = ET.fromstring(xml_path.read_text(encoding='utf-8'))

        covered = int(root.attrib.get('lines-covered', '0'))
        valid = int(root.attrib.get('lines-valid', '0'))
        pct = 0.0 if valid == 0 else (covered / valid) * 100.0
        pct_rounded = int(math.floor(pct + 0.5))

        if pct_rounded >= 90:
          color = '#4c1'
        elif pct_rounded >= 80:
          color = '#dfb317'
        elif pct_rounded >= 70:
          color = '#fe7d37'
        else:
          color = '#e05d44'

        left = 'Python Coverage (3.12)'
        right = f'{pct_rounded}%'

        char_px = 6
        left_w = max(140, len(left) * char_px + 20)
        right_w = max(50, len(right) * char_px + 20)
        total_w = left_w + right_w
        left_x = left_w / 2
        right_x = left_w + (right_w / 2)

        svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="{total_w}" height="20" role="img" aria-label="{left}: {right}">
          <linearGradient id="s" x2="0" y2="100%">
            <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
            <stop offset="1" stop-opacity=".1"/>
          </linearGradient>
          <clipPath id="r">
            <rect width="{total_w}" height="20" rx="3" fill="#fff"/>
          </clipPath>
          <g clip-path="url(#r)">
            <rect width="{left_w}" height="20" fill="#555"/>
            <rect x="{left_w}" width="{right_w}" height="20" fill="{color}"/>
            <rect width="{total_w}" height="20" fill="url(#s)"/>
          </g>
          <g fill="#fff" text-anchor="middle" font-family="Verdana,Geneva,DejaVu Sans,sans-serif" font-size="11">
            <text x="{left_x}" y="15" fill="#010101" fill-opacity=".3">{left}</text>
            <text x="{left_x}" y="14">{left}</text>
            <text x="{right_x}" y="15" fill="#010101" fill-opacity=".3">{right}</text>
            <text x="{right_x}" y="14">{right}</text>
          </g>
        </svg>'''

        Path('coverage.svg').write_text(svg, encoding='utf-8')
        print(f'Python coverage: {pct:.2f}% -> {pct_rounded}%')
        PY

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: llvm-tools-preview

    - name: Install cargo-llvm-cov
      shell: bash
      run: cargo install cargo-llvm-cov --locked --force

    - name: Compute Rust core coverage
      shell: bash
      run: |
        set -euo pipefail

        cargo llvm-cov --all-features --summary-only \
          -p formualizer-common \
          -p formualizer-parse \
          -p formualizer-eval \
          -p formualizer-workbook \
          -p formualizer-sheetport \
          -p sheetport-spec \
          -p formualizer-macros \
          | tee rust-coverage-summary.txt

    - name: Generate Rust core coverage badge
      shell: bash
      run: |
        set -euo pipefail

        python - <<'PY'
        import math
        from pathlib import Path

        lines = Path('rust-coverage-summary.txt').read_text(encoding='utf-8').splitlines()
        total_line = next((line for line in lines if line.startswith('TOTAL')), None)
        if total_line is None:
          raise SystemExit('TOTAL line not found in rust coverage summary')

        percentages = [float(tok.rstrip('%')) for tok in total_line.split() if tok.endswith('%')]
        if len(percentages) < 3:
          raise SystemExit(f'Unable to parse coverage percentages from: {total_line}')

        pct = percentages[2]  # line coverage
        pct_rounded = int(math.floor(pct + 0.5))

        if pct_rounded >= 90:
          color = '#4c1'
        elif pct_rounded >= 80:
          color = '#dfb317'
        elif pct_rounded >= 70:
          color = '#fe7d37'
        else:
          color = '#e05d44'

        left = 'Rust Core Coverage'
        right = f'{pct_rounded}%'

        char_px = 6
        left_w = max(130, len(left) * char_px + 20)
        right_w = max(50, len(right) * char_px + 20)
        total_w = left_w + right_w
        left_x = left_w / 2
        right_x = left_w + (right_w / 2)

        svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="{total_w}" height="20" role="img" aria-label="{left}: {right}">
          <linearGradient id="s" x2="0" y2="100%">
            <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
            <stop offset="1" stop-opacity=".1"/>
          </linearGradient>
          <clipPath id="r">
            <rect width="{total_w}" height="20" rx="3" fill="#fff"/>
          </clipPath>
          <g clip-path="url(#r)">
            <rect width="{left_w}" height="20" fill="#555"/>
            <rect x="{left_w}" width="{right_w}" height="20" fill="{color}"/>
            <rect width="{total_w}" height="20" fill="url(#s)"/>
          </g>
          <g fill="#fff" text-anchor="middle" font-family="Verdana,Geneva,DejaVu Sans,sans-serif" font-size="11">
            <text x="{left_x}" y="15" fill="#010101" fill-opacity=".3">{left}</text>
            <text x="{left_x}" y="14">{left}</text>
            <text x="{right_x}" y="15" fill="#010101" fill-opacity=".3">{right}</text>
            <text x="{right_x}" y="14">{right}</text>
          </g>
        </svg>'''

        Path('rust-core-coverage.svg').write_text(svg, encoding='utf-8')
        print(f'Rust core line coverage: {pct:.2f}% -> {pct_rounded}%')
        PY

    - name: Publish badges to badges branch
      shell: bash
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -euo pipefail
        set -x

        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        mkdir -p /tmp/fz-badges
        cp coverage.svg /tmp/fz-badges/coverage.svg
        cp rust-core-coverage.svg /tmp/fz-badges/rust-core-coverage.svg

        # actions/checkout does not fetch origin/badges, so detect via ls-remote.
        if git ls-remote --exit-code --heads origin badges >/dev/null 2>&1; then
          git fetch --depth=1 origin badges
          git checkout -B badges FETCH_HEAD
        else
          git checkout --orphan badges
        fi

        # Keep the branch as generated badge artifacts only.
        git rm -rf . >/dev/null 2>&1 || true
        git clean -fdx

        cp /tmp/fz-badges/coverage.svg ./coverage.svg
        cp /tmp/fz-badges/rust-core-coverage.svg ./rust-core-coverage.svg
        git add coverage.svg rust-core-coverage.svg
        git commit -m "ci: update coverage badges" || exit 0
        git push origin badges --force-with-lease
