name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test-python:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Install uv
      run: curl -LsSf https://astral.sh/uv/install.sh | sh

    - name: Install Python dependencies
      working-directory: bindings/python
      run: |
        uv venv
        uv pip install maturin
        uv pip install -e ".[dev]"

    - name: Build Python extension
      working-directory: bindings/python
      run: |
        source .venv/bin/activate
        maturin develop

    - name: Run Python linting
      working-directory: bindings/python
      run: |
        source .venv/bin/activate
        ruff check .
        ruff format --check .

    - name: Run Python type checking
      working-directory: bindings/python
      run: |
        source .venv/bin/activate
        mypy formualizer

    - name: Run Python tests with coverage
      working-directory: bindings/python
      run: |
        source .venv/bin/activate
        pytest

    - name: Upload coverage artifact
      if: matrix.python-version == '3.12'
      uses: actions/upload-artifact@v4
      with:
        name: python-coverage
        path: bindings/python/coverage.xml
        if-no-files-found: error

  test-rust:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Check Rust formatting
      run: cargo fmt --all -- --check

    # - name: Run Rust clippy
    #   run: cargo clippy --all-targets --all-features -- -D warnings

    - name: Run Rust tests
      run: cargo test --all-features

  build-wheels:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Build wheels
      uses: PyO3/maturin-action@v1
      with:
        working-directory: bindings/python
        args: --release --out dist --find-interpreter
        sccache: 'true'

    - name: Upload wheels
      uses: actions/upload-artifact@v4
      with:
        name: wheels-${{ matrix.os }}
        path: bindings/python/dist

  coverage-badge:
    needs: test-python
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Download coverage artifact
      uses: actions/download-artifact@v4
      with:
        name: python-coverage
        path: coverage-artifacts

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Generate coverage badge
      shell: bash
      run: |
        set -euo pipefail

        python - <<'PY'
        import math
        import xml.etree.ElementTree as ET
        from pathlib import Path

        xml_path = Path('coverage-artifacts/coverage.xml')
        root = ET.fromstring(xml_path.read_text(encoding='utf-8'))

        covered = int(root.attrib.get('lines-covered', '0'))
        valid = int(root.attrib.get('lines-valid', '0'))
        pct = 0.0 if valid == 0 else (covered / valid) * 100.0
        pct_rounded = int(math.floor(pct + 0.5))

        if pct_rounded >= 90:
          color = '#4c1'
        elif pct_rounded >= 80:
          color = '#dfb317'
        elif pct_rounded >= 70:
          color = '#fe7d37'
        else:
          color = '#e05d44'

        left = 'coverage'
        right = f'{pct_rounded}%'

        # Very simple fixed-size badge; good enough and stable.
        svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="110" height="20" role="img" aria-label="{left}: {right}">
          <linearGradient id="s" x2="0" y2="100%">
            <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
            <stop offset="1" stop-opacity=".1"/>
          </linearGradient>
          <clipPath id="r">
            <rect width="110" height="20" rx="3" fill="#fff"/>
          </clipPath>
          <g clip-path="url(#r)">
            <rect width="60" height="20" fill="#555"/>
            <rect x="60" width="50" height="20" fill="{color}"/>
            <rect width="110" height="20" fill="url(#s)"/>
          </g>
          <g fill="#fff" text-anchor="middle" font-family="Verdana,Geneva,DejaVu Sans,sans-serif" font-size="11">
            <text x="30" y="15" fill="#010101" fill-opacity=".3">{left}</text>
            <text x="30" y="14">{left}</text>
            <text x="85" y="15" fill="#010101" fill-opacity=".3">{right}</text>
            <text x="85" y="14">{right}</text>
          </g>
        </svg>'''

        Path('coverage.svg').write_text(svg, encoding='utf-8')
        print(f'Coverage: {pct:.2f}% -> {pct_rounded}%')
        PY

    - name: Publish badge to badges branch
      shell: bash
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -euo pipefail
        set -x

        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        mkdir -p /tmp/fz-badges
        cp coverage.svg /tmp/fz-badges/coverage.svg

        # actions/checkout does not fetch origin/badges, so detect via ls-remote.
        if git ls-remote --exit-code --heads origin badges >/dev/null 2>&1; then
          git fetch --depth=1 origin badges
          git checkout -B badges FETCH_HEAD
        else
          git checkout --orphan badges
        fi

        # Keep the branch as a single-file badge branch.
        git rm -rf . >/dev/null 2>&1 || true
        git clean -fdx

        cp /tmp/fz-badges/coverage.svg ./coverage.svg
        git add coverage.svg
        git commit -m "ci: update coverage badge" || exit 0
        git push origin badges --force-with-lease
